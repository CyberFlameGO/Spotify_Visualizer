<!doctype html>
<html>
<head>
  <title>Tessellator - A Spotify Music Visualizer</title>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-P3T8H8T');</script>
    <!-- End Google Tag Manager -->
    <!-- Google Analytics -->
    <script>
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', 'UA-133459521-1', 'auto');
        ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133459521-1"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style type="text/css">
      body {
          color: #FFF;
          background-color: rgba(0,0,0,.8);
      }
      li {
          text-align: justify;
      }
      ul {
          padding-left: 0;
      }
      #loggedin, #visualizer-main, #oauth, .paused {
          display: none;
      }
      .text-overflow {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          width: 500px;
      }
      a {
          color: #FFF;
      }
      a:hover, a:focus {
          color: #FFF;
          text-decoration: none;
      }
      canvas {
          width: 100%;
          height: 100%;
          display: flex;
      }
      #visualizer-main {
          color: #b3b3b3;
          background-color: #272727;
      }
      #visualizer-container {
          position: absolute;
          top: -45px;
          width: 100%;
      }
      .random-icon {
          background-image: url('images/random-line-off.svg');
          background-repeat: no-repeat;
          background-size: contain;
          width: 50px;
          height: 50px;
      }
      .random-icon.on {
          background-image: url('images/random-line-on.svg');
          background-repeat: no-repeat;
          background-size: contain;
      }
      #randomizerToggle:hover {
          background-color: transparent;
      }
      #main-container {
          text-align: center;
      }
  </style>
    <meta name="description" content="A real time audio visualizer made with WebGl and the Spotify Web API. Sign into Spotify."/>
    <meta name="google-site-verification" content="yFMbu00NqMj2zQ1ABVo2tN5F4BSKh2UAXJ1cwAXYqdA" />
</head>

<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P3T8H8T"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<div id="main-container" class="container">
  <div id="login" class="align-items-center">
    <div class="row d-flex justify-content-center m-5">
        <h1>Welcome Home</h1>
    </div>
    <div class="row d-flex justify-content-center m-5">
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div class="row d-flex justify-content-center m-5">
        <h4>A real time 3D audio visualizer made with WebGl and the Spotify Web API</h4>
    </div>
  </div>

  <div id="loggedin">
    <div class="row d-flex justify-content-center m-4">
        <h4>A real time 3D audio visualizer made with WebGl and the Spotify Web API</h4>
    </div>

    <div id="user-profile">
    </div>
    <div id="player-info" class="row d-flex justify-content-center m-4">
    </div>
    <div id="oauth">
    </div>

    <div class="row d-flex justify-content-around">
        <button class="btn btn-primary" id="toVisualizer">Spotify Premium Users Only</button>
    </div>
    <div class="row d-flex justify-content-center m-5">
        <p>Use an external speaker or microphone for best results</p>
        <h5>Any comments / suggestions may be sent to <a href="mailto:tessellator.space@gmail.com"> tessellator.space@gmail.com</a></h5>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <h4>Update Log:</h4>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <p>(14/03/2019) Major Update:</p>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <p>Click the <div class="mx-3 random-icon"></div> to randomize between the different modes or use the numbers 1-8</p>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <p>(23/02/2019) Update: Dynamic volume adjustment to analyser</p>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <p>(23/02/2019) Tweak: Added a valence check on camera zooming</p>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
          <p>(23/02/2019) Tweak: Colour modes (1 - 4), 6, (8 - 9)  modified</p>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <p>(23/02/2019) Bug: Major bug fixes (too many to list)</p>
    </div>
    <div class="row d-flex mt-1 justify-content-center">
        <p>(17/02/2019) Tweak: Beat Colour change modified</p>
    </div>
    <div class="row d-flex mb-1 justify-content-center">
        <p>(17/02/2019) Bug: Fixed errors when changing song and wireframe</p>
    </div>
    <div class="row d-flex justify-content-center m-1">
        <p>(14/02/2019) Tweak: Colour modes (4 - 9) modified</p>
    </div>
    <div class="row d-flex justify-content-center m-1">
        <p>(13/02/2019) Update: Camera zoom smoothing</p>
    </div>

    <div class="row d-flex justify-content-center m-2">
        <h4>Coming Soon :</h4>
    </div>
    <div class="row d-flex justify-content-center m-2">
        <ul>
            <li>Player Controls</li>
            <li>Visualizer Controls</li>
            <li>More Modes</li>
            <li>More Settings</li>
        </ul>
    </div>
  </div>

</div>

<div id="visualizer-main">
    <div id="visualizer-container">
        <div class="d-flex justify-content-around">
            <button class="btn btn-outline-light my-2" id="toLoggedIn">Back</button>
            <div id="player-info-visualizer"></div>
            <div id="visualizer-controls"></div>
        </div>
    </div>
</div>

<script id="visualizer-controls-template" type="text/x-handlebars-template">
    <div class="icon-container">
       <button class="btn btn-outline-light my-2" id="randomizerToggle">
           <div id="randomIcon" class="random-icon"></div>
       </button>
    </div>
</script>

<!--<script id="analysis-info-template" type="text/x-handlebars-template">
    <div class="my-1">
        Tempo:  <strong>{{tempo}}</strong>
    </div>
    <div class="my-1">
        Loudness:  <strong>{{loudness}}</strong>
    </div>
</script>-->

<script id="player-info-template" type="text/x-handlebars-template">
    <div class="my-3">
        <div class="playing">Playing <strong>{{item.name}}</strong> by <strong>{{item.artists.0.name}}</strong></div>
        <div class="paused">Paused with <strong>{{item.name}}</strong> by <strong>{{item.artists.0.name}}</strong> queued</div>

        <!--<div class="d-flex justify-content-around my-2 controls">
            <button class="btn"><i class="material-images md-20 md-light">skip_previous</i></button>
            <div class="paused">
                <button class="btn"><i class="material-images md-20 md-light">play_circle_outline</i></button>
            </div>
            <div class="playing">
                <button class="btn"><i class="material-images md-20 md-light">pause_circle_outline</i></button>
            </div>
            <button class="btn"><i class="material-images md-20 md-light">skip_next</i></button>

            &lt;!&ndash;<i class="material-images md-20 md-light">high_quality</i>
            <i class="material-images md-20 md-light">check_box</i>
            <i class="material-images md-20 md-light">check_box_outline_blank</i>&ndash;&gt;
        </div>-->
    </div>
</script>

<script id="user-profile-template" type="text/x-handlebars-template">
    <div class="row d-flex justify-content-center m-5">
        <h1>Hello {{display_name}}</h1>
    </div>
    <div class="row d-flex justify-content-around">
        <div class="pull-left">
            <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
            <button class="btn btn-info"><a target="_blank" href="{{external_urls.spotify}}">Open Web Player in a new tab</a></button>
        </div>
    </div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
  <h2>oAuth info</h2>
  <dl class="dl-horizontal">
    <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
    <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
  </dl>
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script
        src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/three.js/100/three.min.js"></script>
<script src="js/OrbitControls.js"></script>
<script>

    var rmslow = 20;
    var rmshigh = 80;
    var zoomIntensity = 30;
    var xx = 0.4;
    var zz = 0.5;
    var cc = 7500;
    var tc = 0.35;
    var bc = 0.5;
    var spinr = 0;

    var randomizer = false;
    var changedColour = true;
    var setLargeShape = false;
    //Visualizer stuff below
    var gotVisualizerScripts = false;
    var g_danceability = 0;
    var g_energy = 0;
    var g_valence = 0;
    var g_tempo = 0;
    var g_section = 0;
    var g_sections = 0;
    var g_bar = 0;
    var g_bars = 0;
    var g_beat = 0;
    var g_beats = 0;
    var g_tatum = 0;
    var g_tatums = 0;
    var g_segment = 0;
    var g_segments = 0;
    var trackCounter = 0;
    var trackEnd = 999999;
    var isPaused = true;
    var isVisualizer = false;

    var shapeMax = 961;
    var layerMarker = [];

    var taaaa = 0.93;
    var baaaa = 0.97;
    var beatZoom = 0;

    var barStart = 0;
    var barEnd = 0;
    var barCounter = 0;
    var barConfidence = 0;

    var beatStart = 0;
    var beatEnd = 0;
    var beatCounter = 0;
    var beatConfidence = 0;

    var tatumStart = 0;
    var tatumEnd = 0;
    var tatumCounter = 0;
    var tatumConfidence = 0;

    var points = 1;
    var detail = 1;
    var cameraRandom = Math.floor(Math.random() * 7);
    var shapeType;

    function incrementTrackCounter() {
        trackCounter+= 10;
    }

    var doIncrementTrackCounter = setInterval(incrementTrackCounter, 10);
    var refreshID;
    function getRefreshToken() {
        $.ajax({
            url: '/refresh_token',
            data: {
                'refresh_token': refresh_token
            }
        }).done(function(data) {
            access_token = data.access_token;
            oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
            });
        });
    }

    (function() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');
        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');
        var playerInfoSource = document.getElementById('player-info-template').innerHTML,
            playerInfoTemplate = Handlebars.compile(playerInfoSource),
            playerInfoPlaceholder = document.getElementById('player-info'),
            playerInfoVisualizerPlaceholder = document.getElementById('player-info-visualizer');
        var visualizerControlsSource = document.getElementById('visualizer-controls-template').innerHTML,
            visualizerControlsTemplate = Handlebars.compile(visualizerControlsSource),
            visualizerControlsPlaceholder = document.getElementById('visualizer-controls');
        /*var /!*analysisInfoSource = document.getElementById('analysis-info-template').innerHTML,
            analysisInfoTemplate = Handlebars.compile(analysisInfoSource),
            analysisInfoPlaceholder = document.getElementById('analysis-info');*!/*/
        var params = getHashParams();
        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {
                //change url
                window.history.pushState("loggedin", "Logged In", "/loggedin");
                // render oauth info
                oauthPlaceholder.innerHTML = oauthTemplate({
                    access_token: access_token,
                    refresh_token: refresh_token
                });
                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {
                        userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                        //Google Analytics
                        ga('set', {
                            page: '/loggedin',
                            title: 'User Logged In'
                        });
                        ga('set', 'referrer', 'tessellator.herokuapp.com');
                        ga('set', 'userId', response.id);
                        ga('send', 'event', 'authentication', 'user-id available');
                        ga('send', 'pageview');
                        $.getScript("https://sdk.scdn.co/spotify-player.js");
                        $.getScript("js/LiveAudio.js");

                        window.onSpotifyWebPlaybackSDKReady = () => {
                            const token = access_token;
                            const player = new Spotify.Player({
                                name: 'Visualizer Player',
                                getOAuthToken: cb => { cb(token); }
                            });

                            // Error handling
                            player.addListener('initialization_error', ({ message }) => { console.error(message); });
                            player.addListener('authentication_error', ({ message }) => { console.error(message); });
                            player.addListener('account_error', ({ message }) => { console.error(message); });
                            player.addListener('playback_error', ({ message }) => { console.error(message); });

                            // Playback status updates
                            player.addListener('player_state_changed', state => {
                                //console.log(state);
                                trackCounter = state.position;
                                isPaused = state.paused;

                                if (trackCounter < 10){
                                    g_section = 0;
                                    g_bar = 0;
                                    g_beat = 0;
                                    g_tatum = 0;
                                    g_segment = 0;
                                    cameraRandom = 2;
                                    spinr = 0;

                                    /*shapeType = Math.random()*2;*/
                                    if(isVisualizer) {
                                        /*for(let i = 0; i < 81; i++) {
                                            changeShapeType(detail, i, shapeType);
                                        }
                                        newShapePosition();*/
                                    }
                                    analyser.minDecibels = -90;
                                    analyser.maxDecibels = -25;
                                }
                                trackEnd = state.duration;

                                $.ajax({
                                    url: 'https://api.spotify.com/v1/me/player',
                                    headers: {
                                        'Authorization': 'Bearer ' + access_token
                                    },
                                    success: function(response) {
                                        if(!gotVisualizerScripts) {
                                            $.getScript("js/ColourLayerChanger.js");
                                            $.getScript("js/ModeChanger.js");
                                            $.getScript("js/main.js");
                                            $.getScript("js/KeyboardInput.js");
                                        }

                                        gotVisualizerScripts = true;
                                        //console.log('player response');
                                        //console.log(response);

                                        playerInfoPlaceholder.innerHTML = playerInfoTemplate(response);
                                        playerInfoVisualizerPlaceholder.innerHTML = playerInfoTemplate(response);
                                        visualizerControlsPlaceholder.innerHTML = visualizerControlsTemplate(response);

                                        $('#randomizerToggle').click(function() {
                                            randomizer = !randomizer;
                                            console.log(randomizer);
                                            if(randomizer == true) {
                                                $( "#randomIcon" ).addClass( "on" );
                                            } else {
                                                $( "#randomIcon" ).removeClass( "on" );
                                            }
                                        });

                                        $.ajax({
                                            url: 'https://api.spotify.com/v1/audio-features/' + response.item.id,
                                            headers: {
                                                'Authorization': 'Bearer ' + access_token
                                            },
                                            success: function(response) {
                                                console.log('features response');
                                                console.log(response);

                                                g_valence = response.valence;
                                                g_energy = response.energy;
                                                g_danceability = response.danceability;

                                                beatZoom = 0.75 + g_danceability/10;
                                                console.log(beatZoom);

                                                /*analysisInfoPlaceholder.innerHTML = analysisInfoTemplate(response);*/

                                                if(0.75/response.energy < 0.94) {
                                                    analyser.smoothingTimeConstant = 0.75 / g_energy;
                                                } else if (0.75/response.danceability < 0.94) {
                                                    analyser.smoothingTimeConstant = 0.75 / g_danceability;
                                                } else {
                                                    analyser.smoothingTimeConstant = 0.94;
                                                }

                                                console.log("smoothing: " + analyser.smoothingTimeConstant);
                                                zoomIntensity = 300 - response.tempo;
                                                g_tempo = response.tempo;

                                                $.ajax({
                                                    url: response.analysis_url,
                                                    headers: {
                                                        'Authorization': 'Bearer ' + access_token
                                                    },
                                                    success: function (response) {
                                                        //console.log('analysis response');
                                                        //console.log(response);

                                                        g_sections = response.sections;
                                                        g_bars = response.bars;
                                                        g_beats = response.beats;
                                                        g_tatums = response.tatums;
                                                        g_segments = response.segments;

                                                        taaaa = 0;
                                                        for (let i = 0; i < g_tatums.length; i++) {
                                                            taaaa = taaaa + g_tatums[i]["confidence"];
                                                        }
                                                        taaaa = taaaa/g_tatums.length;
                                                        console.log("taaaa = " + taaaa);
                                                        taaaa = taaaa + g_energy/(3+g_danceability/g_valence);
                                                        console.log("taaaa = " + taaaa);


                                                        document.getElementById('toVisualizer').addEventListener('click', function () {
                                                            //change url
                                                            window.history.pushState("visualizer", "Visualizer", "/visualizer");
                                                            ga('set', {
                                                                page: '/visualizer',
                                                                title: 'User started the visualizer'
                                                            });
                                                            ga('send', 'pageview');
                                                            $.ajax({
                                                                url: 'https://api.spotify.com/v1/me',
                                                                headers: {
                                                                    'Authorization': 'Bearer ' + access_token
                                                                },
                                                                success: function(response) {
                                                                    playerInfoPlaceholder.innerHTML = playerInfoTemplate(response);
                                                                }
                                                            });

                                                            refreshID = setInterval(getRefreshToken, 1800000);

                                                            $('#loggedin').hide();
                                                            $('#main-container').hide();
                                                            $('#visualizer-main').show();
                                                            isVisualizer = true;
                                                        });
                                                    }
                                                });
                                            }
                                        });
                                    }
                                });
                            });

                            // Ready
                            player.addListener('ready', ({ device_id }) => {
                                console.log('Ready with Device ID', device_id);
                                $.ajax({
                                    url: 'https://api.spotify.com/v1/me/top/tracks',
                                    headers: {
                                        'Authorization': 'Bearer ' + access_token
                                    },
                                    success: function(response) {
                                        play({
                                            spotify_uri: response.items[Math.floor(Math.random() * 20)].uri,
                                            playerInstance: (player),
                                        });
                                    }
                                });
                            });

                            // Not Ready
                            player.addListener('not_ready', ({ device_id }) => {
                                console.log('Device ID has gone offline', device_id);
                            });

                            // Connect to the player!
                            player.connect();
                            const play = ({
                                              spotify_uri,
                                              playerInstance: {
                                                  _options: {
                                                      getOAuthToken,
                                                      id
                                                  }
                                              }
                                          }) => {
                                getOAuthToken(access_token => {
                                    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
                                        method: 'PUT',
                                        body: JSON.stringify({ uris: [spotify_uri] }),
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${access_token}`
                                        },
                                    });
                                });
                            };
                        };
                        $('#login').hide();
                        $('#visualizer-main').hide();
                        $('#loggedin').show();
                    }
                });
            } else {
                // render initial screen
                $('#login').show();
                $('#visualizer-main').hide();
                $('#loggedin').hide();
            }

            document.getElementById('toLoggedIn').addEventListener('click', function () {
                //change url
                window.history.pushState("loggedin", "Logged In", "/loggedin");
                ga('set', {
                    page: '/loggedin',
                    title: 'Back to Logged In'
                });
                ga('send', 'pageview');
                $('#login').hide();
                $('#visualizer-main').hide();
                $('#main-container').show();
                $('#loggedin').show();
                clearTimeout(refreshID);
                isVisualizer = false;
            });
            /*document.getElementById('toPlayer').addEventListener('click', function () {
                ga('set', {
                    page: '/player',
                    title: 'User opened Player'
                });
                ga('send', 'pageview');
                ga('set', {
                    page: '/loggedin',
                    title: 'Back to Logged In'
                });
            });*/

            $('#visualizer-main').on('mousemove', function(event) {
                if(45 - event.clientY < 0) {
                    $('#visualizer-container').css({top: 45 - event.clientY});
                } else {
                    $('#visualizer-container').css({top: 0});
                }
            }).on('mouseout', function() {
                $('#visualizer-container').css({top: -45});
            });
        }
    })();
</script>
</body>
</html>