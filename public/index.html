<!doctype html>
<html>
<head>
  <title>Example of the Authorization Code flow with Spotify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style type="text/css">
    #login, #loggedin, #visualizer-main {
      display: none;
    }
    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
    canvas {
        width: 100%;
        height: 100%;
        display: flex;
    }
    #visualizer-main .container {
        height: 4%;
    }
    #visualizer-main .container .row .media {
        display: flex;
    }
    #visualizer-main .container .row .media .media-body {
        padding: 0 3%;
    }
    #visualizer-main #visualizer {
        width: 100%;
    }
  </style>
</head>

<body>
<div id="main-container" class="container">
  <div id="login">
    <h1>This is an example of the Authorization Code flow</h1>
    <a href="/login" class="btn btn-primary">Log in with Spotify</a>
  </div>
  <div id="loggedin">
    <div id="user-profile">
    </div>
    <div id="oauth">
    </div>
    <div class="row">
      <div class="col-md-6">
        <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-primary" id="toVisualizer">Get to the good stuff!!!</button>
      </div>
    </div>
  </div>
</div>
<div id="visualizer-main">
    <div class="container">
        <div class="row">
            <div class="media">
                <button class="btn btn-secondary" id="toLoggedIn">Back</button>
                <div id="visualizer"></div>
            </div>
        </div>
    </div>
</div>

<script id="visualizer-template" type="text/x-handlebars-template">
    <div class="media-body">
        <div>Currently Playing <strong>{{item.name}}</strong> by <strong>{{item.artists.0.name}}</strong></div>
    </div>
</script>

<script id="user-profile-template" type="text/x-handlebars-template">
  <h1>Logged in as {{display_name}}</h1>
  <div class="media">
    <div class="pull-left">
      <img class="media-object" width="150" src="{{images.0.url}}" />
    </div>
    <div class="media-body">
      <dl class="dl-horizontal">
        <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
        <dt>Id</dt><dd>{{id}}</dd>
        <dt>Email</dt><dd>{{email}}</dd>
        <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
        <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
        <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
        <dt>Country</dt><dd>{{country}}</dd>
      </dl>
    </div>
  </div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
  <h2>oAuth info</h2>
  <dl class="dl-horizontal">
    <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
    <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
  </dl>
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script type="text/javascript" src="js/three.js"></script>
<script src="js/OrbitControls.js"></script>
<script>
    //Visualizer stuff below
    var g_tempo = 0;
    var layer1_tempo, layer2_tempo, layer3_tempo;

    (function() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }
        var gotVisualizerScripts = false;
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');
        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');
        var visualizerSource = document.getElementById('visualizer-template').innerHTML,
            visualizerTemplate = Handlebars.compile(visualizerSource),
            visualizerPlaceholder = document.getElementById('visualizer');
        var params = getHashParams();
        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {
                // render oauth info
                oauthPlaceholder.innerHTML = oauthTemplate({
                    access_token: access_token,
                    refresh_token: refresh_token
                });
                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {
                        userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                        $('#login').hide();
                        $('#visualizer-main').hide();
                        $('#loggedin').show();
                        $.getScript("https://sdk.scdn.co/spotify-player.js");

                        window.onSpotifyWebPlaybackSDKReady = () => {
                            const token = access_token;
                            const player = new Spotify.Player({
                                name: 'Visualizer Player',
                                getOAuthToken: cb => { cb(token); }
                            });

                            // Error handling
                            player.addListener('initialization_error', ({ message }) => { console.error(message); });
                            player.addListener('authentication_error', ({ message }) => { console.error(message); });
                            player.addListener('account_error', ({ message }) => { console.error(message); });
                            player.addListener('playback_error', ({ message }) => { console.error(message); });

                            // Playback status updates
                            player.addListener('player_state_changed', state => {
                                console.log(state);
                                $.ajax({
                                    url: 'https://api.spotify.com/v1/me/player',
                                    headers: {
                                        'Authorization': 'Bearer ' + access_token
                                    },
                                    success: function(response) {
                                        visualizerPlaceholder.innerHTML = visualizerTemplate(response);
                                        $.ajax({
                                            url: 'https://api.spotify.com/v1/audio-features/' + response.item.id,
                                            headers: {
                                                'Authorization': 'Bearer ' + access_token
                                            },
                                            success: function(response) {
                                                console.log(response);
                                                g_tempo = response.tempo;
                                            }
                                        });
                                    }
                                });
                            });

                            // Ready
                            player.addListener('ready', ({ device_id }) => {
                                console.log('Ready with Device ID', device_id);
                                $.ajax({
                                    url: 'https://api.spotify.com/v1/me/top/tracks',
                                    headers: {
                                        'Authorization': 'Bearer ' + access_token
                                    },
                                    success: function(response) {
                                        play({
                                            spotify_uri: response.items[Math.floor(Math.random() * 10)].uri,
                                            playerInstance: (player),
                                        });
                                    }
                                });
                            });

                            // Not Ready
                            player.addListener('not_ready', ({ device_id }) => {
                                console.log('Device ID has gone offline', device_id);
                            });

                            // Connect to the player!
                            player.connect();
                            const play = ({
                                              spotify_uri,
                                              playerInstance: {
                                                  _options: {
                                                      getOAuthToken,
                                                      id
                                                  }
                                              }
                                          }) => {
                                getOAuthToken(access_token => {
                                    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
                                        method: 'PUT',
                                        body: JSON.stringify({ uris: [spotify_uri] }),
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${access_token}`
                                        },
                                    });
                                });
                            };
                        };

                    }
                });
            } else {
                // render initial screen
                $('#login').show();
                $('#visualizer-main').hide();
                $('#loggedin').hide();
            }
            document.getElementById('toVisualizer').addEventListener('click', function () {
                $('#loggedin').hide();
                $('#main-container').hide();
                $('#visualizer-main').show();
                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {
                        visualizerPlaceholder.innerHTML = visualizerTemplate(response);
                    }
                });


                if(!gotVisualizerScripts) {
                    gotVisualizerScripts = true;
                    $.getScript("js/LiveAudio.js");
                    $.getScript("js/ColourLayerChanger.js");
                    $.getScript("js/ModeChanger.js");
                    $.getScript("js/main.js");
                    $.getScript("js/KeyboardInput.js");
                }
            });
            document.getElementById('toLoggedIn').addEventListener('click', function () {
                $('#login').hide();
                $('#visualizer-main').hide();
                $('#main-container').show();
                $('#loggedin').show();
            });
            document.getElementById('obtain-new-token').addEventListener('click', function() {
                $.ajax({
                    url: '/refresh_token',
                    data: {
                        'refresh_token': refresh_token
                    }
                }).done(function(data) {
                    access_token = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: access_token,
                        refresh_token: refresh_token
                    });
                });
            }, false);
        }
    })();
</script>
</body>
</html>